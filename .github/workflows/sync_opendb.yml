name: Sync BuildCore OpenDB

on:
  schedule:
    # Runs every day at 02:00 UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allows you to manually trigger the workflow from the GitHub UI

jobs:
  update-database:
    runs-on: ubuntu-latest
    
    # Needs permission to push code to your repository
    permissions:
      contents: write

    steps:
      # 1. Checkout your own repository into a folder named 'main-repo'
      - name: Checkout my repository
        uses: actions/checkout@v4
        with:
          path: 'main-repo'

      # 2. Checkout the BuildCore repository
      - name: Checkout BuildCore repository
        uses: actions/checkout@v4
        with:
          repository: 'buildcores/buildcores-open-db' 
          path: 'buildcore-repo'

      # 3. Setup Python to run the processor
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      # 4. Copy data temporarily, process it, and clean up
      - name: Process data and cleanup
        run: |
          # Create temporary folder
          mkdir -p main-repo/raw_hardware_data
          
          # Copy the contents from the 'open-db' folder
          cp -a buildcore-repo/open-db/* main-repo/raw_hardware_data/
          
          # Navigate to repo and run the python processor script
          cd main-repo
          python data_processor.py
          
          # IMPORTANT: Delete the 42,000 raw files so they are NOT committed to GitHub
          rm -rf raw_hardware_data/
          
          # Create a subfolder for the processed data and move the files safely
          mkdir -p processed_data
          
          # Move only recently created JSON files to avoid moving things like package.json
          find . -maxdepth 1 -name "*.json" -type f -mmin -5 -exec mv {} processed_data/ \;
          
      # 5. Commit and Push ALL generated category JSON files from the subfolder
      - name: Commit and push changes
        run: |
          cd main-repo
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all JSON files located in the new subfolder
          git add processed_data/*.json
          
          # Only commit and push if there are actual changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update processed hardware categories into subfolder [skip ci]" && git push)